{% extends "base.html" %}
{% block content %}
  <h2>Reportes del sistema</h2>

  <section class="reports-grid">
    <div class="card">
      <h3>Parte I ‚Äì Reporte diario</h3>
      <p>D√≠a: <strong>{{ diarios.dia }}</strong></p>
      <p>Ganancia total: <strong>{{ diarios.ganancia_total }} ‚Ç¨</strong></p>

      <h4>Servicios seguidos (hasta 5)</h4>
      <ul class="list">
      {% for s in diarios.servicios_seguimiento %}
        <li>
          <div class="list-title">
            Taxi {{ s.id_taxi }} ‚Üí Cliente {{ s.id_cliente }}
          </div>
          <div class="list-body">
            Origen:
            {{ s.direccion_origen or s.origen }}<br>
            Destino:
            {{ s.direccion_destino or s.destino }}<br>
            Km: {{ '%.2f'|format(s.km) }} ‚Ä¢ Costo: {{ '%.2f'|format(s.costo|default(0.0)) }} ‚Ç¨ ‚Ä¢ Calificaci√≥n: {{ s.calificacion }}
          </div>
        </li>
      {% else %}
        <li>No hay servicios a√∫n.</li>
      {% endfor %}
      </ul>
    </div>

    <div class="card">
      <h3>Parte II ‚Äì Resumen por taxista</h3>
      <ul class="list">
      {% for t in mensuales %}
        <li>
          <div class="list-title">
            Taxi {{ t.id_taxi }} ‚Äì {{ t.nombre }} ({{ t.placa }})
          </div>
          <div class="list-body">
            Total generado: <strong style="color: #00c46a;">{{ '%.2f'|format(t.total_generado|default(0.0)) }} ‚Ç¨</strong><br>
            Importe mensual (20%): <strong>{{ '%.2f'|format(t.importe_mensual|default(0.0)) }} ‚Ç¨</strong><br>
            Ganancia taxista (80%): <strong style="color: #ffb703;">{{ '%.2f'|format(t.ganancia_taxista|default(0.0)) }} ‚Ç¨</strong>
          </div>
        </li>
      {% else %}
        <li>No hay datos de taxis todav√≠a.</li>
      {% endfor %}
      </ul>
      {% if mensuales|length > 0 %}
      <div style="margin-top:2em;">
        <canvas id="taxiBarChart" height="180"></canvas>
      </div>
      <!-- Datos serializados en JSON para evitar errores de sintaxis JS/Jinja -->
      <script id="mensualesData" type="application/json">{{ mensuales|tojson }}</script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
        try {
          const mensualesData = JSON.parse(document.getElementById('mensualesData').textContent || '[]');
          const taxiLabels = mensualesData.map(t => t.nombre || '');
          const taxiGanancias = mensualesData.map(t => Number((t.ganancia_taxista || 0).toFixed(2)));
          const ctx = document.getElementById('taxiBarChart').getContext('2d');
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: taxiLabels,
              datasets: [{
                label: 'Ganancia taxista (‚Ç¨)',
                data: taxiGanancias,
                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        } catch (e) {
          console.error('Error inicializando la gr√°fica:', e);
        }
      </script>
      {% endif %}
    </div>
    
    {% if resumenes_diarios %}
    <div class="card">
      <h3>Res√∫menes Diarios Hist√≥ricos</h3>
      <ul class="list">
      {% for resumen in resumenes_diarios %}
        <li>
          <div class="list-title">
            üìä {{ resumen.fecha }}
          </div>
          <div class="list-body">
            Viajes totales: <strong>{{ resumen.viajes_totales }}</strong><br>
            Ganancias totales: <strong style="color: #00c46a;">{{ '%.2f'|format(resumen.ganancias_totales) }} ‚Ç¨</strong><br>
            Ganancias tarifa alta: <strong style="color: #ffb703;">{{ '%.2f'|format(resumen.ganancias_tarifa_alta) }} ‚Ç¨</strong><br>
            Conductor m√°s activo: {{ resumen.conductor_mas_viajes }}<br>
            Cliente m√°s frecuente: {{ resumen.cliente_mas_frecuente }}
          </div>
        </li>
      {% endfor %}
      </ul>
    </div>
    {% endif %}
  </section>
{% endblock %}

