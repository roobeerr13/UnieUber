{% extends "base.html" %}
{% block content %}
  <div class="reports-header">
    <h2>üìä Reportes del Sistema</h2>
    <div class="reports-summary">
      <div class="summary-card">
        <div class="summary-label">Ganancia Total</div>
        <div class="summary-value">{{ '%.2f'|format(diarios.ganancia_total|default(0.0)) }} ‚Ç¨</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">D√≠a Actual</div>
        <div class="summary-value">{{ diarios.dia }}</div>
      </div>
    </div>
  </div>

  <section class="reports-grid">
    <div class="card">
      <h3 class="card-title">üìã Reporte Diario</h3>
      <div class="daily-stats">
        <div class="stat-box">
          <div class="stat-label">Ganancia Total</div>
          <div class="stat-value highlight-green">{{ '%.2f'|format(diarios.ganancia_total|default(0.0)) }} ‚Ç¨</div>
        </div>
      </div>

      <h4 class="section-subtitle">üöï Servicios Recientes (√∫ltimos 5)</h4>
      <div class="services-list">
      {% for s in diarios.servicios_seguimiento %}
        <div class="service-card">
          <div class="service-header">
            <span class="service-icon">üöñ</span>
            <div class="service-title">
              <strong>Taxi {{ s.id_taxi }}</strong> ‚Üí Cliente {{ s.id_cliente }}
            </div>
          </div>
          <div class="service-details">
            <div class="service-detail-row">
              <span class="service-detail-label">üìç Origen:</span>
              <span class="service-detail-value">{{ s.direccion_origen or s.origen }}</span>
            </div>
            <div class="service-detail-row">
              <span class="service-detail-label">üéØ Destino:</span>
              <span class="service-detail-value">{{ s.direccion_destino or s.destino }}</span>
            </div>
            <div class="service-metrics">
              <div class="service-metric">
                <span class="metric-label">Distancia</span>
                <span class="metric-value">{{ '%.2f'|format(s.km) }} km</span>
              </div>
              <div class="service-metric">
                <span class="metric-label">Costo</span>
                <span class="metric-value highlight-green">{{ '%.2f'|format(s.costo|default(0.0)) }} ‚Ç¨</span>
              </div>
              <div class="service-metric">
                <span class="metric-label">‚≠ê Calificaci√≥n</span>
                <span class="metric-value">{{ s.calificacion }}/5</span>
              </div>
            </div>
          </div>
        </div>
      {% else %}
        <div class="empty-state">No hay servicios a√∫n.</div>
      {% endfor %}
      </div>
    </div>

    <div class="card">
      <h3 class="card-title">üë• Resumen por Conductor</h3>
      <div class="drivers-list">
      {% for t in mensuales %}
        <div class="driver-card">
          <div class="driver-header">
            <div class="driver-avatar">üöï</div>
            <div class="driver-info">
              <div class="driver-name">{{ t.nombre }}</div>
              <div class="driver-placa">Placa: {{ t.placa }}</div>
            </div>
          </div>
          <div class="driver-stats">
            <div class="driver-stat">
              <div class="driver-stat-label">Total Generado</div>
              <div class="driver-stat-value highlight-green">{{ '%.2f'|format(t.total_generado|default(0.0)) }} ‚Ç¨</div>
            </div>
            <div class="driver-stat">
              <div class="driver-stat-label">Ganancia del conductor (80%)</div>
              <div class="driver-stat-value highlight-yellow">{{ '%.2f'|format(t.ganancia_taxista|default(0.0)) }} ‚Ç¨</div>
            </div>
            <div class="driver-stat">
              <div class="driver-stat-label">Comisi√≥n plataforma (20%)</div>
              <div class="driver-stat-value">{{ '%.2f'|format(t.importe_mensual|default(0.0)) }} ‚Ç¨</div>
            </div>
          </div>
        </div>
      {% else %}
        <div class="empty-state">No hay datos de taxis todav√≠a.</div>
      {% endfor %}
      </div>
      {% if mensuales|length > 0 %}
      <div class="chart-container">
        <canvas id="taxiBarChart"></canvas>
      </div>
      <!-- Datos serializados en JSON para evitar errores de sintaxis JS/Jinja -->
      <script id="mensualesData" type="application/json">{{ mensuales|tojson }}</script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
        try {
          const mensualesData = JSON.parse(document.getElementById('mensualesData').textContent || '[]');
          const taxiLabels = mensualesData.map(t => t.nombre || '');
          const taxiGanancias = mensualesData.map(t => Number((t.ganancia_taxista || 0).toFixed(2)));
          const ctx = document.getElementById('taxiBarChart').getContext('2d');
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: taxiLabels,
              datasets: [{
                label: 'Ganancia taxista (‚Ç¨)',
                data: taxiGanancias,
                backgroundColor: '#00D4AA',
                borderColor: '#00D4AA',
                borderWidth: 2,
                borderRadius: 8
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    color: '#888',
                    font: {
                      size: 12
                    }
                  },
                  grid: {
                    color: '#2a2a2a'
                  }
                },
                x: {
                  ticks: {
                    color: '#888',
                    font: {
                      size: 12
                    }
                  },
                  grid: {
                    color: '#2a2a2a'
                  }
                }
              }
            }
          });
        } catch (e) {
          console.error('Error inicializando la gr√°fica:', e);
        }
      </script>
      {% endif %}
    </div>
    
    {% if resumenes_diarios %}
    <div class="card">
      <h3 class="card-title">üìÖ Res√∫menes Diarios Hist√≥ricos</h3>
      <div class="daily-summaries">
      {% for resumen in resumenes_diarios %}
        <div class="daily-summary-card">
          <div class="daily-summary-header">
            <span class="daily-summary-date">üìä {{ resumen.fecha }}</span>
          </div>
          <div class="daily-summary-stats">
            <div class="daily-stat">
              <span class="daily-stat-label">Viajes</span>
              <span class="daily-stat-value">{{ resumen.viajes_totales }}</span>
            </div>
            <div class="daily-stat">
              <span class="daily-stat-label">Ganancias</span>
              <span class="daily-stat-value highlight-green">{{ '%.2f'|format(resumen.ganancias_totales) }} ‚Ç¨</span>
            </div>
            <div class="daily-stat">
              <span class="daily-stat-label">Tarifa Alta</span>
              <span class="daily-stat-value highlight-yellow">{{ '%.2f'|format(resumen.ganancias_tarifa_alta) }} ‚Ç¨</span>
            </div>
          </div>
          <div class="daily-summary-highlights">
            <div class="highlight-item">
              <span class="highlight-icon">üëë</span>
              <span class="highlight-text">{{ resumen.conductor_mas_viajes }}</span>
            </div>
            <div class="highlight-item">
              <span class="highlight-icon">‚≠ê</span>
              <span class="highlight-text">{{ resumen.cliente_mas_frecuente }}</span>
            </div>
          </div>
        </div>
      {% endfor %}
      </div>
    </div>
    {% endif %}
  </section>
{% endblock %}

