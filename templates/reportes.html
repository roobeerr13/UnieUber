{% extends "base.html" %}
{% block content %}
  <h2>Reportes del sistema</h2>

  <section class="reports-grid">
    <div class="card">
      <h3>Parte I – Reporte diario</h3>
      <p>Día: <strong>{{ diarios.dia }}</strong></p>
      <p>Ganancia total: <strong>{{ diarios.ganancia_total }} €</strong></p>

      <h4>Servicios seguidos (hasta 5)</h4>
      <ul class="list">
      {% for s in diarios.servicios_seguimiento %}
        <li>
          <div class="list-title">
            Taxi {{ s.id_taxi }} → Cliente {{ s.id_cliente }}
          </div>
          <div class="list-body">
            Origen:
            {{ s.direccion_origen or s.origen }}<br>
            Destino:
            {{ s.direccion_destino or s.destino }}<br>
            Km: {{ s.km }} • Costo: {{ s.costo }} € • Calificación: {{ s.calificacion }}
          </div>
        </li>
      {% else %}
        <li>No hay servicios aún.</li>
      {% endfor %}
      </ul>
    </div>

    <div class="card">
      <h3>Parte II – Resumen por taxista</h3>
      <ul class="list">
      {% for t in mensuales %}
        <li>
          <div class="list-title">
            Taxi {{ t.id_taxi }} – {{ t.nombre }} ({{ t.placa }})
          </div>
          <div class="list-body">
            Total generado: {{ t.total_generado }} €<br>
            Importe mensual (20%): {{ t.importe_mensual }} €<br>
            Ganancia taxista (80%): {{ t.ganancia_taxista }} €
          </div>
        </li>
      {% else %}
        <li>No hay datos de taxis todavía.</li>
      {% endfor %}
      </ul>
      <div style="margin-top:2em;">
        <canvas id="taxiBarChart" height="180"></canvas>
      </div>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script>
        const taxiLabels = [{{ mensuales|map(attribute='nombre')|map('tojson')|join(', ') }}];
        const taxiGanancias = [{{ mensuales|map(attribute='ganancia_taxista')|join(', ') }}];
        const ctx = document.getElementById('taxiBarChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: taxiLabels,
            datasets: [{
              label: 'Ganancia taxista (€)',
              data: taxiGanancias,
              backgroundColor: 'rgba(255, 206, 86, 0.7)',
              borderColor: 'rgba(255, 206, 86, 1)',
              borderWidth: 1
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      </script>
    </div>
  </section>
{% endblock %}

