{% extends "base.html" %}
{% block content %}
  <div class="uber-container">
    <div class="card">
      <h2>Solicita tu viaje</h2>
      <p class="card-subtitle">
        Introduce tu punto de recogida y destino. Por dentro usamos hilos y sem√°foros,
        pero por fuera parece una app normal üòå
      </p>
      <form method="post" class="uber-form">
        <label>
          ID Cliente
          <input type="text" name="cliente_id" value="cliente-web">
        </label>

        <h3>Origen</h3>
        <label>
          Calle y n√∫mero
          <input type="text" name="direccion_origen" placeholder="Calle Mayor 12">
        </label>
        <label>
          C√≥digo Postal
          <input type="text" name="cp_origen" placeholder="28013">
        </label>
        <label>
          Ciudad
          <input type="text" name="ciudad_origen" placeholder="Madrid">
        </label>

        <h3>Destino</h3>
        <label>
          Calle y n√∫mero
          <input type="text" name="direccion_destino" placeholder="Av. de Am√©rica 45">
        </label>
        <label>
          C√≥digo Postal
          <input type="text" name="cp_destino" placeholder="28028">
        </label>
        <label>
          Ciudad
          <input type="text" name="ciudad_destino" placeholder="Madrid">
        </label>

        <button type="submit" class="btn-primary">Confirmar viaje</button>
      </form>
    </div>

    <div class="map-fake">
      <div class="map-header">
        <span class="dot live"></span> Vista simulada del mapa
      </div>
      <div class="map-body">
        {% if direccion_origen and direccion_destino and orig_lat is not none and orig_lon is not none and dest_lat is not none and dest_lon is not none %}
          <div class="map-inner">
            <div id="map" style="height: 400px;"></div>
            <div class="map-badge">
              <span>Viaje en curso</span>
              <small>Simulaci√≥n sobre mapa real</small>
            </div>
          </div>
          <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
          <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
          <script>
            const origLat = parseFloat("{{ orig_lat|default('0') }}");
            const origLon = parseFloat("{{ orig_lon|default('0') }}");
            const destLat = parseFloat("{{ dest_lat|default('0') }}");
            const destLon = parseFloat("{{ dest_lon|default('0') }}");
            const taxiIcon = L.icon({
              iconUrl: "https://emojiapi.dev/api/v1/taxi/64.png",
              iconSize: [32, 32],
              iconAnchor: [16, 16]
            });
            const map = L.map('map').setView([(origLat + destLat)/2, (origLon + destLon)/2], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: '¬© OpenStreetMap'
            }).addTo(map);
            // Marcadores origen/destino
            L.marker([origLat, origLon], {title: "Origen"}).addTo(map).bindPopup("Origen").openPopup();
            L.marker([destLat, destLon], {title: "Destino"}).addTo(map).bindPopup("Destino");
            // L√≠nea entre puntos
            const route = L.polyline([[origLat, origLon], [destLat, destLon]], {color: 'blue'}).addTo(map);
            // Taxi emoji animado
            let taxiMarker = L.marker([origLat, origLon], {icon: taxiIcon}).addTo(map);
            let steps = 100;
            let i = 0;
            function animateTaxi() {
              i++;
              if (i > steps) return;
              let lat = origLat + (destLat - origLat) * (i/steps);
              let lon = origLon + (destLon - origLon) * (i/steps);
              taxiMarker.setLatLng([lat, lon]);
              setTimeout(animateTaxi, 30);
            }
            animateTaxi();
          </script>
        {% else %}
          <div class="map-placeholder">
            Introduce origen y destino y ver√°s aqu√≠ el mapa real con el taxi movi√©ndose.
          </div>
        {% endif %}
      </div>
      <div class="map-footer">
        {% if dist_km is not none and precio is not none %}
          <div style="margin-top:1em; font-size:1.2em; margin-bottom: 12px;">
            üöï Distancia aprox: <b>{{ '%.2f'|format(dist_km) }} km</b> ¬∑ Precio estimado: <b>{{ '%.2f'|format(precio) }} ‚Ç¨</b>
            {% if modo_tarifa_alta %}
              <span style="color: #ffb703; font-size: 0.9em;">üåô Tarifa Alta</span>
            {% endif %}
          </div>
        {% endif %}
        
        {% if taxi_info %}
          <div class="taxi-assigned-card">
            <div class="taxi-assigned-header">
              <div class="taxi-icon-large">üöñ</div>
              <div class="taxi-assigned-info">
                <div class="taxi-assigned-title">Tu conductor</div>
                <div class="taxi-assigned-name">{{ taxi_info.nombre }}</div>
                <div class="taxi-assigned-placa">Placa: {{ taxi_info.placa }}</div>
              </div>
            </div>
            <div class="taxi-assigned-details">
              <div class="taxi-detail-item">
                <span class="taxi-detail-label">‚≠ê Calificaci√≥n</span>
                <span class="taxi-detail-value">{{ taxi_info.calificacion }}/5.0</span>
              </div>
              <div class="taxi-detail-item">
                <span class="taxi-detail-label">üìä Viajes hoy</span>
                <span class="taxi-detail-value">{{ taxi_info.viajes_hoy }}</span>
              </div>
            </div>
          </div>
        {% endif %}
        
        {% if cliente_info %}
          <div class="cliente-profile-card">
            <div class="cliente-profile-header">
              <span class="cliente-profile-icon">üë§</span>
              <span class="cliente-profile-title">Tu Perfil</span>
            </div>
            <div class="cliente-profile-stats">
              <div class="cliente-stat">
                <span class="cliente-stat-label">Viajes realizados</span>
                <span class="cliente-stat-value">{{ cliente_info.frecuencia }}</span>
              </div>
              <div class="cliente-stat">
                <span class="cliente-stat-label">Nivel</span>
                <span class="cliente-stat-stars">{% for i in range(cliente_info.estrellas) %}‚≠ê{% endfor %}</span>
              </div>
            </div>
          </div>
        {% endif %}
        
        <div>
          <span class="label">Tipo de viaje</span>
          <span class="value">Simulaci√≥n acad√©mica</span>
        </div>
        <div>
          <span class="label">Estado</span>
          <span class="value">{% if taxi_info %}Taxi asignado{% else %}En espera de solicitud{% endif %}</span>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
