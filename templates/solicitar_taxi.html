{% extends "base.html" %}
{% block content %}
  <div class="ride-request-container">
    <div class="ride-form-section">
      <div class="card">
        <div class="form-header">
          <h2>üöñ Solicita tu viaje</h2>
          <p class="card-subtitle">
            Completa los datos para solicitar un taxi
          </p>
        </div>
        <form method="post" class="uber-form" id="rideForm">
        <label>
          ID Cliente
          <input type="text" name="cliente_id" value="cliente-web">
        </label>

        <h3>Origen</h3>
        <label>
          Calle y n√∫mero
          <input type="text" name="direccion_origen" placeholder="Calle Mayor 12">
        </label>
        <label>
          C√≥digo Postal
          <input type="text" name="cp_origen" placeholder="28013">
        </label>
        <label>
          Ciudad
          <input type="text" name="ciudad_origen" placeholder="Madrid">
        </label>

        <h3>Destino</h3>
        <label>
          Calle y n√∫mero
          <input type="text" name="direccion_destino" placeholder="Av. de Am√©rica 45">
        </label>
        <label>
          C√≥digo Postal
          <input type="text" name="cp_destino" placeholder="28028">
        </label>
        <label>
          Ciudad
          <input type="text" name="ciudad_destino" placeholder="Madrid">
        </label>

          <button type="submit" class="btn-primary btn-large">üöñ Solicitar Taxi</button>
        </form>
      </div>
    </div>

    <div class="ride-info-section">
      {% if direccion_origen and direccion_destino %}
        <div class="card map-card">
          <div class="map-header">
            <span class="dot live"></span> 
            <span>Ruta del viaje</span>
          </div>
          <div class="map-body">
            {% if orig_lat is not none and orig_lon is not none and dest_lat is not none and dest_lon is not none %}
              <div class="map-inner">
                <div id="map"></div>
              </div>
              <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
              <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
              <script>
                const origLat = parseFloat("{{ orig_lat|default('0') }}");
                const origLon = parseFloat("{{ orig_lon|default('0') }}");
                const destLat = parseFloat("{{ dest_lat|default('0') }}");
                const destLon = parseFloat("{{ dest_lon|default('0') }}");
                
                // Crear mapa
                const map = L.map('map').setView([(origLat + destLat)/2, (origLon + destLon)/2], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                  maxZoom: 19,
                  attribution: '¬© OpenStreetMap'
                }).addTo(map);
                
                // Iconos personalizados
                const originIcon = L.divIcon({
                  className: 'custom-marker origin-marker',
                  html: '<div class="marker-pin origin">üìç</div>',
                  iconSize: [30, 30],
                  iconAnchor: [15, 30]
                });
                
                const destIcon = L.divIcon({
                  className: 'custom-marker dest-marker',
                  html: '<div class="marker-pin dest">üéØ</div>',
                  iconSize: [30, 30],
                  iconAnchor: [15, 30]
                });
                
                const taxiIcon = L.divIcon({
                  className: 'custom-marker taxi-marker',
                  html: '<div class="marker-pin taxi">üöñ</div>',
                  iconSize: [40, 40],
                  iconAnchor: [20, 40]
                });
                
                // Marcadores
                const originMarker = L.marker([origLat, origLon], {icon: originIcon}).addTo(map);
                originMarker.bindPopup("<b>üìç Origen</b><br>" + "{{ direccion_origen|e }}").openPopup();
                
                const destMarker = L.marker([destLat, destLon], {icon: destIcon}).addTo(map);
                destMarker.bindPopup("<b>üéØ Destino</b><br>" + "{{ direccion_destino|e }}");
                
                // Ruta
                const route = L.polyline([[origLat, origLon], [destLat, destLon]], {
                  color: '#00D4AA',
                  weight: 4,
                  opacity: 0.7
                }).addTo(map);
                
                // Animaci√≥n del taxi
                let taxiMarker = L.marker([origLat, origLon], {icon: taxiIcon}).addTo(map);
                let steps = 50;
                let currentStep = 0;
                
                function animateTaxi() {
                  if (currentStep > steps) {
                    currentStep = 0; // Reiniciar animaci√≥n
                  }
                  const progress = currentStep / steps;
                  const lat = origLat + (destLat - origLat) * progress;
                  const lon = origLon + (destLon - origLon) * progress;
                  taxiMarker.setLatLng([lat, lon]);
                  currentStep++;
                  setTimeout(animateTaxi, 100);
                }
                animateTaxi();
              </script>
            {% else %}
              <div class="map-placeholder">
                <div class="placeholder-icon">üó∫Ô∏è</div>
                <p>Calculando ruta...</p>
              </div>
            {% endif %}
          </div>
        </div>
      {% else %}
        <div class="card map-card">
          <div class="map-placeholder">
            <div class="placeholder-icon">üìç</div>
            <p>Completa el formulario para ver la ruta</p>
          </div>
        </div>
      {% endif %}
      
      {% if dist_km is not none and precio is not none %}
        <div class="card ride-summary-card">
          <div class="ride-summary-header">
            <h3>üìä Resumen del viaje</h3>
          </div>
          <div class="ride-summary-content">
            <div class="summary-item">
              <span class="summary-label">Distancia</span>
              <span class="summary-value">{{ '%.2f'|format(dist_km) }} km</span>
            </div>
            <div class="summary-item highlight">
              <span class="summary-label">Precio estimado</span>
              <span class="summary-value price">{{ '%.2f'|format(precio) }} ‚Ç¨</span>
            </div>
            {% if modo_tarifa_alta %}
            <div class="summary-item">
              <span class="summary-label">Tarifa</span>
              <span class="summary-value tarifa-alta">üåô Alta</span>
            </div>
            {% endif %}
          </div>
        </div>
      {% endif %}
        
        {% if taxi_info %}
          <div class="taxi-assigned-card">
            <div class="taxi-assigned-header">
              <div class="taxi-icon-large">üöñ</div>
              <div class="taxi-assigned-info">
                <div class="taxi-assigned-title">Tu conductor</div>
                <div class="taxi-assigned-name">{{ taxi_info.nombre }}</div>
                <div class="taxi-assigned-placa">Placa: {{ taxi_info.placa }}</div>
              </div>
            </div>
            <div class="taxi-assigned-details">
              <div class="taxi-detail-item">
                <span class="taxi-detail-label">‚≠ê Calificaci√≥n</span>
                <span class="taxi-detail-value">{{ taxi_info.calificacion }}/5.0</span>
              </div>
              <div class="taxi-detail-item">
                <span class="taxi-detail-label">üìä Viajes hoy</span>
                <span class="taxi-detail-value">{{ taxi_info.viajes_hoy }}</span>
              </div>
            </div>
          </div>
        {% endif %}
        
        {% if cliente_info %}
          <div class="cliente-profile-card">
            <div class="cliente-profile-header">
              <span class="cliente-profile-icon">üë§</span>
              <span class="cliente-profile-title">Tu Perfil</span>
            </div>
            <div class="cliente-profile-stats">
              <div class="cliente-stat">
                <span class="cliente-stat-label">Viajes realizados</span>
                <span class="cliente-stat-value">{{ cliente_info.frecuencia }}</span>
              </div>
              <div class="cliente-stat">
                <span class="cliente-stat-label">Nivel</span>
                <span class="cliente-stat-stars">{% for i in range(cliente_info.estrellas) %}‚≠ê{% endfor %}</span>
              </div>
            </div>
          </div>
        {% endif %}
        
    </div>
  </div>
{% endblock %}
