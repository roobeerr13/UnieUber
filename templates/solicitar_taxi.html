{% extends "base.html" %}
{% block content %}
  <div class="uber-container">
    <div class="card">
      <h2>Solicita tu viaje</h2>
      <p class="card-subtitle">
        Introduce tu punto de recogida y destino. Por dentro usamos hilos y sem√°foros,
        pero por fuera parece una app normal üòå
      </p>
      <form method="post" class="uber-form">
        <label>
          ID Cliente
          <input type="text" name="cliente_id" value="cliente-web">
        </label>

        <h3>Origen</h3>
        <label>
          Calle y n√∫mero
          <input type="text" name="direccion_origen" placeholder="Calle Mayor 12">
        </label>
        <label>
          C√≥digo Postal
          <input type="text" name="cp_origen" placeholder="28013">
        </label>
        <label>
          Ciudad
          <input type="text" name="ciudad_origen" placeholder="Madrid">
        </label>

        <h3>Destino</h3>
        <label>
          Calle y n√∫mero
          <input type="text" name="direccion_destino" placeholder="Av. de Am√©rica 45">
        </label>
        <label>
          C√≥digo Postal
          <input type="text" name="cp_destino" placeholder="28028">
        </label>
        <label>
          Ciudad
          <input type="text" name="ciudad_destino" placeholder="Madrid">
        </label>

        <button type="submit" class="btn-primary">Confirmar viaje</button>
      </form>
    </div>

    <div class="map-fake">
      <div class="map-header">
        <span class="dot live"></span> Vista simulada del mapa
      </div>
<div class="map-body">
  {% if direccion_origen and direccion_destino %}
    <div class="map-inner">
      <div id="map"></div>
      <div class="map-badge">
        <span>Viaje en curso</span>
        <small>Simulaci√≥n sobre mapa real</small>
      </div>
    </div>

    <script>
      const originAddress = "{{ direccion_origen | escape }}";
      const destinationAddress = "{{ direccion_destino | escape }}";

      let map;
      let directionsService;
      let directionsRenderer;
      let carMarker;
      let routePolyline;
      let routePath = [];
      let animIndex = 0;
      let animTimer = null;

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 13,
          center: { lat: 40.4168, lng: -3.7038 }, // Madrid por defecto
          mapId: "DEMO_MAP_ID"
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
          map: map,
          suppressMarkers: true
        });

        calcularRuta(originAddress, destinationAddress);
      }

      function calcularRuta(origen, destino) {
        directionsService.route(
          {
            origin: origen,
            destination: destino,
            travelMode: google.maps.TravelMode.DRIVING
          },
          (result, status) => {
            if (status === "OK" && result.routes.length > 0) {
              directionsRenderer.setDirections(result);
              const route = result.routes[0].overview_path;
              routePath = route;

              // Marcadores A y B
              new google.maps.Marker({
                position: route[0],
                map: map,
                label: "A"
              });

              new google.maps.Marker({
                position: route[route.length - 1],
                map: map,
                label: "B"
              });

              // Coche (emoji)
              carMarker = new google.maps.Marker({
                position: route[0],
                map: map,
                label: "",
                icon: {
                  url: "https://emojiapi.dev/api/v1/taxi/64.png",
                  scaledSize: new google.maps.Size(32, 32)
                }
              });

              animIndex = 0;
              animarCoche();
            } else {
              console.error("No se pudo calcular la ruta:", status);
            }
          }
        );
      }

      function animarCoche() {
        if (!routePath || routePath.length === 0) return;

        if (animTimer) {
          clearInterval(animTimer);
        }

        animTimer = setInterval(() => {
          animIndex++;
          if (animIndex >= routePath.length) {
            clearInterval(animTimer);
            return;
          }
          const pos = routePath[animIndex];
          carMarker.setPosition(pos);
        }, 200); // mueve el coche cada 200 ms
      }
    </script>
  {% else %}
    <div class="map-placeholder">
      Introduce origen y destino y ver√°s aqu√≠ el mapa real con el taxi movi√©ndose.
    </div>
  {% endif %}
</div>


      <div class="map-footer">
        <div>
          <span class="label">Tipo de viaje</span>
          <span class="value">Simulaci√≥n acad√©mica</span>
        </div>
        <div>
          <span class="label">Estado</span>
          <span class="value">En espera de solicitud</span>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
